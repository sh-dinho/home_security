<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Home Security System Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Keyframe for Flashing Effect */
        @keyframes flash {
            0%, 100% { background-color: #f87171; } /* Red-400 */
            50% { background-color: #ef4444; } /* Red-500 */
        }

        /* Apply flash animation when the 'alert-mode' class is present */
        .alert-mode {
            animation: flash 0.5s ease-in-out infinite alternate;
        }

        /* Custom scrollbar styling */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: #6b7280; /* Gray-500 */
            border-radius: 4px;
        }
    </style>
</head>

<body class="font-sans min-h-screen bg-gray-900 text-white transition-all duration-300 {% if is_alert %}alert-mode{% endif %}">

<!-- Navigation -->
<header class="bg-gray-800 shadow-lg sticky top-0 z-10">
    <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
        <h1 class="text-2xl font-extrabold text-indigo-400 tracking-wider">
            Guardian AI
        </h1>
        <div class="space-x-4">
            <a href="/" class="text-white hover:text-indigo-400 transition duration-150 font-medium">Dashboard</a>
            <a href="/events" class="text-white hover:text-indigo-400 transition duration-150 font-medium">Event Log</a>
        </div>
    </nav>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

    <!-- System Status Banner -->
    <div class="mb-8 p-6 rounded-xl shadow-2xl transition-all duration-500
            {% if is_alert %} bg-red-700/90 border-4 border-white/50 text-white font-black text-center text-3xl pulse-effect
            {% elif is_armed %} bg-green-600/90 border-4 border-green-400
            {% else %} bg-gray-700/80 border-4 border-gray-600
            {% endif %}">
        <p class="text-sm font-semibold opacity-80 mb-1">{{ now() }}</p>
        {% if is_alert %}
        <p class="animate-pulse">‚ö†Ô∏è CRITICAL ALERT: FIRE/SMOKE DETECTED! ‚ö†Ô∏è</p>
        {% else %}
        <p class="text-4xl font-bold">SYSTEM STATUS: {{ 'ARMED' if is_armed else 'DISARMED' }}</p>
        {% endif %}
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Column 1: Video Feed & Controls -->
        <div class="lg:col-span-2 space-y-8">

            <!-- Video Stream Card -->
            <div class="bg-gray-800 rounded-xl shadow-2xl p-4">
                <h2 class="text-xl font-semibold mb-3 text-indigo-400">Live Video Feed (AI Motion Detection)</h2>
                <div class="relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden border-2 border-gray-700">
                    <!-- Video Feed Image -->
                    <img src="{{ url_for('video_feed') }}" class="w-full h-full object-cover" alt="Live Security Camera Feed">
                    <!-- Armed Status Overlay -->
                    <div class="absolute top-2 right-2 px-3 py-1 rounded-full text-xs font-bold transition-colors duration-500
                            {% if is_armed %} bg-red-600 text-white {% else %} bg-gray-500 text-white {% endif %}">
                        {{ 'ARMED' if is_armed else 'DISARMED' }}
                    </div>
                </div>
            </div>

            <!-- Control Panel Card -->
            <div class="bg-gray-800 rounded-xl shadow-2xl p-6">
                <h2 class="text-xl font-semibold mb-4 text-indigo-400">System Control</h2>
                <form method="POST" action="{{ url_for('arm_disarm') }}" class="w-full">
                    <button type="submit" class="w-full py-4 rounded-lg font-bold text-lg shadow-xl transition-all duration-300 transform hover:scale-[1.01]
                            {% if is_armed %}
                                bg-red-600 hover:bg-red-500 text-white border-b-4 border-red-700
                            {% else %}
                                bg-green-600 hover:bg-green-500 text-white border-b-4 border-green-700
                            {% endif %}">
                        {% if is_armed %}
                        DISARM SYSTEM
                        {% else %}
                        ARM SYSTEM
                        {% endif %}
                    </button>
                </form>
                <p class="text-xs text-gray-400 mt-3 text-center">
                    Toggle to arm or disarm the security motion and contact sensors. Critical alerts (like smoke) are always active.
                </p>
            </div>
        </div>

        <!-- Column 2: Sensor Status -->
        <div class="lg:col-span-1 bg-gray-800 rounded-xl shadow-2xl p-6 h-full">
            <h2 class="text-xl font-semibold mb-4 text-indigo-400">Sensor Status Overview ({{ sensor_states|length }} Devices)</h2>

            <div class="space-y-4 max-h-[800px] overflow-y-auto custom-scroll">
                {% for name, state in sensor_states.items() %}
                {% set is_open = 'open' in state.lower() or 'detected' in state.lower() %}
                {% set is_critical = 'smoke' in name.lower() or 'fire' in name.lower() %}

                <div class="p-4 rounded-lg flex justify-between items-center transition-all duration-300 border-l-4
                            {% if is_critical and is_open %}
                                bg-red-900 border-red-500 hover:bg-red-800
                            {% elif is_open and is_armed %}
                                bg-yellow-900 border-yellow-500 hover:bg-yellow-800
                            {% else %}
                                bg-gray-700 border-green-500 hover:bg-gray-600
                            {% endif %}">

                    <!-- Sensor Name and Status Icon -->
                    <div class="flex items-center space-x-3">
                                <span class="text-xl">
                                    {% if is_critical %}
                                        üî•
                                    {% elif is_open %}
                                        üö®
                                    {% else %}
                                        ‚úÖ
                                    {% endif %}
                                </span>
                        <div>
                            <p class="font-medium text-sm">{{ name }}</p>
                            <p class="text-xs font-bold
                                        {% if is_critical and is_open %} text-red-300 
                                        {% elif is_open %} text-yellow-300 
                                        {% else %} text-green-300 
                                        {% endif %}">
                                {{ state.upper() }}
                            </p>
                        </div>
                    </div>

                    <!-- Status Indicator -->
                    <span class="w-3 h-3 rounded-full
                                {% if is_critical and is_open %} bg-red-500 animate-ping 
                                {% elif is_open %} bg-yellow-500 
                                {% else %} bg-green-500 
                                {% endif %}">
                            </span>
                </div>
                {% endfor %}
            </div>
        </div>

    </div>
</main>
</body>
</html>